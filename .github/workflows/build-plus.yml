name: Build Plus

on:
  workflow_call:
    inputs:
      arch:
        required: true
        type: string
        default: x64
      os:
        required: true
        type: string
      # Dependency versions
      qt-version:
        required: false
        type: string
        default: '5.15.0'
      vtk-cache-key:
        required: true
        type: string
      itk-cache-key:
        required: true
        type: string

      # Plus cache
      plus-cache-key:
        required: false
        type: string

      # Plus build options
      plus-config:
        required: true
        type: string

      # Uploaded archive name
      archive-name:
        required: false
        type: string
        default: PlusInstaller

      # Repos/tags for PlusLib and PlusApp
      pluslib-repository:
        required: false
        type: string
        default: https://github.com/PlusToolkit/PlusLib.git
      pluslib-tag:
        required: false
        type: string
        default: master
      plusapp-repository:
        required: false
        type: string
        default: https://github.com/Sunderlandkyl/PlusApp.git
      plusapp-tag:
        required: false
        type: string
        default: install_branch_temp
      
      use-pltools:
        required: false
        type: boolean
        default: false

    secrets:
      pltools-access-token:
        required: false

jobs:
  build:
    runs-on: ${{ inputs.os }}

    steps:
    - name: Restore VTK Cache
      uses: actions/cache/restore@v4
      with:
        path: vtk-install
        key: ${{ inputs.vtk-cache-key }}

    - name: Restore ITK Cache
      uses: actions/cache/restore@v4
      with:
        path: itk-install
        key: ${{ inputs.itk-cache-key }}

    - name: Plus Cache
      if: ${{ inputs.plus-cache-key != '' }}
      id: cache-plus
      uses: actions/cache@v4
      with:
        path: build
        key: ${{ inputs.plus-cache-key }}

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        dir: ${{ github.workspace }}/Qt
        version: ${{ inputs.qt-version }}
        arch: ${{ inputs.arch == 'x64' && 'win64_msvc2019_64' || 'win32_msvc2019' }}

    - name: Install Doxygen
      uses: ssciwr/doxygen-install@v1

    - name: Install Graphviz
      uses: ts-graphviz/setup-graphviz@v2

    - name: Clone PlusBuild
      uses: actions/checkout@v4
      with:
        repository: PlusToolkit/PlusBuild
        ref: master
        path: PlusBuild

    - name: Clone PLTools
      if: ${{ inputs.use-pltools }}
      uses: actions/checkout@v4
      with:
        repository: PerkLab/PLTools
        ref: master
        path: PLTools
        token: ${{ secrets.pltools-access-token }}

    - name: Configure PlusBuild
      run: |
        cmake -S PlusBuild -B build `
          -G "Visual Studio 17 2022" -A ${{ inputs.arch }} `
          -DCMAKE_BUILD_TYPE=Release `
          -DPLUSLIB_GIT_REPOSITORY=${{ inputs.pluslib-repository }} `
          -DPLUSLIB_GIT_REVISION=${{ inputs.pluslib-tag }} `
          -DPLUSAPP_GIT_REPOSITORY=${{ inputs.plusapp-repository }} `
          -DPLUSAPP_GIT_REVISION=${{ inputs.plusapp-tag }} `
          -DQt5_Dir="${QT_DIR}" `
          ${{ inputs.plus-config }}

    - name: Build
      working-directory: ${{github.workspace}}/build
      run: |
        ctest -C Release -D Experimental -V

    # Run PlusApp-bin/CreateUserManual.bat
    - uses: ilammy/msvc-dev-cmd@v1
    - name: Create user manual
      working-directory: ${{github.workspace}}/build/PlusApp-bin
      run: |
        ./CreateUserManual.bat

    - name: Debug Plus documentation output
      if: contains(runner.os, 'Windows')
      shell: pwsh
      working-directory: ${{ github.workspace }}
      run: |
        Write-Host "=== Doc Debug: Paths ==="
        $ws      = $Env:GITHUB_WORKSPACE
        $build   = Join-Path $ws 'build'
        $docDir  = Join-Path $build 'bin\Doc'
        $chmPath = Join-Path $docDir 'PlusApp-UserManual.chm'

        Write-Host "GITHUB_WORKSPACE : $ws"
        Write-Host "Build directory  : $build"
        Write-Host "Doc directory    : $docDir"
        Write-Host "Expected CHM     : $chmPath"
        Write-Host ""

        Write-Host "=== Doc directory listing (top-level) ==="
        if (Test-Path $docDir) {
          Get-ChildItem $docDir | Format-Table -AutoSize
        } else {
          Write-Warning "Doc directory does NOT exist at $docDir"
        }
        Write-Host ""

        Write-Host "=== Doc directory listing (recursive) ==="
        if (Test-Path $docDir) {
          Get-ChildItem $docDir -Recurse | Select-Object FullName, Length, LastWriteTime | Format-Table -AutoSize
        } else {
          Write-Host "(Skipping recursive listing, doc dir missing.)"
        }
        Write-Host ""

        Write-Host "=== Check expected CHM ==="
        if (Test-Path $chmPath) {
          $f = Get-Item $chmPath
          Write-Host "CHM found at expected path:"
          Write-Host "  Path      : $($f.FullName)"
          Write-Host "  Size      : $($f.Length) bytes"
          Write-Host "  Modified  : $($f.LastWriteTime)"
        } else {
          Write-Warning "Expected CHM file NOT found at $chmPath"
          Write-Host "Searching entire build tree for any .chm:"
          if (Test-Path $build) {
            Get-ChildItem $build -Filter *.chm -Recurse -ErrorAction SilentlyContinue |
              Select-Object FullName, Length, LastWriteTime | Format-Table -AutoSize
          } else {
            Write-Warning "Build directory $build does not exist; nothing to search."
          }
        }
        Write-Host ""

        Write-Host "=== Tooling info (doxygen / HTML Help) ==="
        Write-Host "doxygen:"
        Get-Command doxygen -ErrorAction SilentlyContinue | Format-Table -AutoSize
        try {
          doxygen --version
        } catch {
          Write-Warning "Failed to run 'doxygen --version'"
        }
        Write-Host ""

        Write-Host "hhc / HTML Help Workshop:"
        Get-Command hhc.exe -ErrorAction SilentlyContinue | Format-Table -AutoSize
        if (Test-Path 'C:\Program Files (x86)\HTML Help Workshop\hhc.exe') {
          Write-Host "Found HTML Help Workshop at C:\Program Files (x86)\HTML Help Workshop\hhc.exe"
        } else {
          Write-Warning "HTML Help Workshop not found in default path."
        }
        Write-Host "=== End Doc Debug ==="

    - uses: ilammy/msvc-dev-cmd@v1
    - name: Package
      if: contains(runner.os, 'windows')
      working-directory: ${{github.workspace}}/build/PlusApp-bin
      run: |
        ./CreatePackage.bat

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.archive-name }}
        path: ${{github.workspace}}/build/PlusApp-bin/*.exe

    # Delete the installer so that it isn't included in the cache.
    - name: Delete installer
      shell: bash
      run: |
        rm -rfv build/PlusApp-bin/*.exe
        rm -rfv build/PlusApp-bin/*.zip
        rm -rfv build/PlusApp-bin/_CPack_Packages
